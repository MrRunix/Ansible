# ANSIBLE

##  lab намбер севан
> ЗАДАЧИ:
1. Настроить консул ( использовать уже готовую роль и инветори).
2. База данных должна быть проинициализирована на выделенных дисках (в Vargrantfile они уже подключены). БД должна находить в папке /pgsql/pg_data/14. WAL архивы должны находить в папке /pgsql/pg_wal/14. В эти папки должны быть примонтированы диски /dev/sdb и /dev/sdc соответственно. Диски должны быть подключены в LVM и отформатированы в файловой системе xfs.
3. На серверах pg1 и pg2 настроить оркестратор репликации Patroni (пакет в архиве).
4. С помощью утилиты vip-manager обеспечить настройку VIP адреса на мастер сервере. https://github.com/cybertec-postgresql/vip-manager/releases/download/v1.0.2/vip-manager-1.0.2-1.x86_64.rpm . Напоминаю, что в конфиге vip-manager необходимо настроить подключение по DCS Consul. IP адрес подключения 127.0.0.1:8500. Так же нужно будет указать consul_token, переменную которого можно взять в роли consul

> Ход работы:
+ Чекаем Vagrantfile и исправляем его, если это необходимо
+ Запускаем Vagrant, а после запускаем consul.play
+ Редактируем наш inventory, чтоб ansible видел нашиххостов и принадобности, распределяем их по группам
+ В ansible.cfg добавляем наш inventory, для удобства добавив нужные нам параметы
+ Создаём папку roles где мы распишем playbooks для наших хостов.
+ + Создаём папку Hendlers, в которой будет playbook для перезагрузки postgresql
+ + Создаём папку tasks, в которой будет playbook для закачки тех или иных пакетов, монтирования дисков, исправления внутренних файлов
+ + Создаём папку templates, в ней будет храниться вся конфигурация, в данном случае (postgresql.yml, vip-manager.yml)
+ + Создаём папку vars, заносим в неё все переменные, необходимые для автоматизации процесса. Записываем туда порт для прослушки и подключения postgresql
+ Теперь можем запустить manul.yml (в нём обязательно укажите, камим хостам принадлежат папки)

> Проверка

+ Заходим на один из наших servers:
+ + Проверем нашу реплику и лидера
![web](https://github.com/MrRunix/Ansible/blob/main/task_7/screenshots/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%20%D0%BE%D1%82%202022-04-15%2010-52-35.png)
+ + Если всё работает, меняем лидера и проверяем
![web](https://github.com/MrRunix/Ansible/blob/main/task_7/screenshots/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%20%D0%BE%D1%82%202022-04-15%2010-54-59.png)
![web](https://github.com/MrRunix/Ansible/blob/main/task_7/screenshots/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%20%D0%BE%D1%82%202022-04-15%2011-01-19.png)
+ ну-с летс го ту дринк сам коффи <3